# FastAPI App with StreamChatBlocks

A complete example application showing how to use StreamChatBlocks with FastAPI. This example is **self-contained** - you can download just this folder and run it!

## Architecture

```
fastapi-app/
├── backend/
│   ├── main.py          # FastAPI server with API endpoints
│   ├── requirements.txt # Python dependencies
│   └── static/          # Production build (generated by frontend build)
├── frontend/
│   ├── src/
│   │   ├── App.tsx      # React app using StreamChatBlocks
│   │   └── main.tsx     # Entry point
│   ├── package.json     # Frontend dependencies
│   └── vite.config.ts   # Build config (outputs to backend/static)
└── Makefile             # All commands
```

## Quick Start

### Prerequisites

- Node.js 18+ and npm
- [uv](https://astral.sh/uv) for Python package management

### Option 1: Development Mode (Recommended for Development)

Run frontend and backend separately with hot-reload:

```bash
# One-time setup
make setup

# Run both servers in parallel
make dev
```

This starts:
- **Frontend dev server**: `http://localhost:3000` (with hot-reload)
- **Backend API server**: `http://localhost:8000`

The frontend proxies `/api/*` requests to the backend.

### Option 2: Production Mode (Single Server)

Build frontend and serve everything from FastAPI:

```bash
# One-time setup
make setup

# Build and run
make build  # Builds frontend to backend/static/
make prod   # Run FastAPI on port 8000
```

Open `http://localhost:8000` - FastAPI serves both the UI and API.

## Available Commands

```bash
make help           # Show all commands

# Setup
make install-uv     # Install uv package manager
make link-lib       # Link streamchatblocks from parent repo
make install        # Install frontend dependencies
make setup          # Complete setup (all of the above)

# Development (2 servers)
make dev-frontend   # Run frontend only (port 3000)
make dev-backend    # Run backend only (port 8000)
make dev            # Run both in parallel

# Production (1 server)
make build          # Build frontend
make prod           # Run production server (port 8000)

# Maintenance
make clean          # Clean build artifacts
```

## How It Works

### Development Mode

1. **Frontend** (`npm run dev`): Vite dev server on port 3000
   - Hot module replacement
   - Proxies `/api/*` to backend
   - Imports `streamchatblocks` via npm link

2. **Backend** (`uvicorn main:app --reload`): FastAPI on port 8000
   - Provides `/api/stream` and `/api/feedback` endpoints
   - CORS enabled for localhost:3000

### Production Mode

1. **Build** (`npm run build`):
   - Vite builds React app
   - Outputs to `backend/static/`
   - Optimized and minified

2. **Serve** (`uvicorn main:app`):
   - FastAPI serves static files from `backend/static/`
   - Same server handles UI and API
   - No CORS issues

## File Structure

### Frontend (`frontend/`)

- `src/App.tsx` - Main React component using StreamChatBlocks
- `src/main.tsx` - React entry point
- `package.json` - Declares `streamchatblocks` as dependency
- `vite.config.ts` - Configures build output and API proxy

### Backend (`backend/`)

- `main.py` - FastAPI app with SSE streaming endpoints
- `requirements.txt` - Python dependencies (FastAPI, uvicorn)
- `static/` - Frontend build output (generated)

## API Endpoints

### `POST /api/stream`

Stream chat responses using Server-Sent Events.

**Request:**
```json
{
  "message": "What is aspirin?",
  "history": []
}
```

**Response:** SSE stream with events:
- `{"type": "token", "content": "..."}`
- `{"type": "block", "block": {...}}`
- `{"type": "done"}`

### `POST /api/feedback`

Submit user feedback.

**Request:**
```json
{
  "message_id": "123",
  "feedback": "Very helpful"
}
```

### `GET /api/health`

Health check endpoint.

## Using This Example Standalone

Want to use this example in your own project? You can!

### If StreamChatBlocks is published to npm:

1. Copy this entire `fastapi-app/` folder
2. Update `frontend/package.json` to use the published version:
   ```json
   {
     "dependencies": {
       "streamchatblocks": "^0.1.0"
     }
   }
   ```
3. Run:
   ```bash
   make install-uv
   cd frontend && npm install
   make dev
   ```

### If using local development:

1. Clone the main repo
2. Build the library: `cd ../../ && npm install && npm run build`
3. Run `make setup` in this directory
4. Run `make dev`

## Customizing

### Change Theme

Edit `frontend/src/App.tsx`:

```tsx
const chatConfig: ChatConfig = {
  theme: {
    primaryColor: '#28a745',  // Your brand color!
    backgroundColor: '#ffffff',
    messageBackgroundColor: '#f5f5f5',
  },
};
```

### Add Custom Components

1. Import community components:
   ```tsx
   import { MyCustomBlock } from 'streamchatblocks';
   ```

2. Register the renderer:
   ```tsx
   customRenderers.set('MyCustomBlock', (block) => (
     <MyCustomBlock block={block} />
   ));
   ```

3. Return from backend:
   ```python
   yield f"data: {json.dumps({
       'type': 'block',
       'block': {
           'type': 'custom',
           'data': {
               'componentType': 'MyCustomBlock',
               'props': {...}
           }
       }
   })}\n\n"
   ```

### Connect Your AI Model

Edit `backend/main.py` - replace the mock `generate_sse_response()` with your AI:

```python
async def generate_sse_response(user_message: str):
    # Your AI model here
    async for token in your_ai_model.stream(user_message):
        yield f"data: {json.dumps({'type': 'token', 'content': token})}\n\n"

    yield f"data: {json.dumps({'type': 'done'})}\n\n"
```

## Deployment

### Docker (Recommended)

```dockerfile
FROM python:3.11
# Copy app
COPY fastapi-app /app
WORKDIR /app

# Build frontend
RUN cd frontend && npm install && npm run build

# Install backend deps
RUN pip install uv && cd backend && uv pip install -r requirements.txt

# Run
CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Manual Deploy

```bash
# Build
cd frontend && npm run build

# Deploy backend/ folder with static/ directory
cd backend
uv run uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

## Troubleshooting

### "Module not found: streamchatblocks"

Run `make link-lib` to link the library from the parent repo.

### "Frontend not built"

Run `make build` to build the frontend.

### Port already in use

Change ports in:
- `frontend/vite.config.ts` - frontend dev port
- `make prod` command - backend port

### CORS errors

In development, the frontend proxies API requests. In production, everything is on the same origin - no CORS needed!

## Learn More

- [StreamChatBlocks Documentation](../../README.md)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Vite Documentation](https://vitejs.dev/)
